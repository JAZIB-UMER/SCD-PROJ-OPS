name: Build, Push, and Update GitOps

on:
  push:
    branches:
      - dev-kubernetes

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout app code
        uses: actions/checkout@v4

      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Build with Maven
        run: mvn -B clean package -DskipTests

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and push Docker image with Git SHA tag
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: jazibumer/scd_proj_image:${{ github.sha::7 }}

      - name: Update GitOps Repository (dev-kubernetes branch)
        run: |
          IMAGE_TAG=${GITHUB_SHA::7}

          echo "üöÄ Starting GitOps update process..."
          echo "Target branch: dev-kubernetes"
          echo "New image tag: $IMAGE_TAG"

          # Clone GitOps repository
          git clone https://${{ secrets.GITOPS_PAT }}@github.com/JAZIB-UMER/SCD-GIT-OPS.git gitops-repo
          cd gitops-repo

          # Checkout target branch
          git checkout dev-kubernetes
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"

          # Ensure deployment file exists
          if [ ! -f "K8s/deployment.yaml" ]; then
            echo "‚ùå K8s/deployment.yaml not found!"
            exit 1
          fi

          echo "üìã Current image line:"
          grep "image:" K8s/deployment.yaml || echo "No image line found"

          echo "‚úèÔ∏è Updating image tag to: $IMAGE_TAG"
          sed -i "s|image: jazibumer/scd_proj_image:.*|image: jazibumer/scd_proj_image:$IMAGE_TAG|g" K8s/deployment.yaml

          echo "üìã Updated deployment.yaml:"
          grep "image:" K8s/deployment.yaml

          # Check for changes
          if git diff --quiet K8s/deployment.yaml; then
            echo "‚ö†Ô∏è No changes detected ‚Äî tag may already be up-to-date"
            exit 0
          fi

          # Commit and push
          git add K8s/deployment.yaml
          git commit -m "üîÑ Update image tag to $IMAGE_TAG [commit: ${{ github.sha }}]"
          git push origin dev-kubernetes

          echo "‚úÖ GitOps repo updated with tag: $IMAGE_TAG"
